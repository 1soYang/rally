- hosts: all
  name: a run script for rally-install-* jobs
  tasks:
    - name: Get list of packages to install from bindep
      command: "bindep -b -f {{ zuul.project.src_dir }}/bindep.txt"
      register: bindep_output
      ignore_errors: True

    - name: Install distro packages from bindep
      package:
        name: "{{ bindep_output.stdout_lines }}"
        state: present
      become: yes
      when: bindep_output.stdout_lines

    - name: Install Rally and check
      shell:
        cmd: |
          # install system wide
          sudo pip3 install --constraint ./upper-constraints.txt ./

          rally --version
          rally db create
          rally env list

        executable: /bin/sh
        chdir: '{{ zuul.project.src_dir }}'
